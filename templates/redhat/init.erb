#!/bin/bash
# /etc/init.d/doozerd

DAEMON_PATH=<%= File.join(@doozerd_path, "bin") %>

DAEMON=doozerd
DAEMONOPTS=""

NAME=doozerd
PIDFILE=<%= @doozerd_pidfile %>
SCRIPTNAME=/etc/init.d/$NAME
LOGFILE=/var/log/$NAME.log

start_command() {
    printf "%-50s" "Starting: $NAME"
    cd $DAEMON_PATH
    GOPATH=<%= @doozerd_path %>
    PID=`GOPATH=$GOPATH $DAEMON $DAEMONOPTS &> $LOGFILE & echo $!`
    if [ -z $PID ]; then
        echo "Failed!"
    else
        cat $PID > $PIDFILE
        echo "OK."
    fi
}

stop_command() {
    printf "%-50s" "Stopping: $NAME"
    PID=`cat $PIDFILE`
    cd $DAEMON_PATH
    if [ -f $PIDFILE ]; then
        kill -HUP $PID
        echo "OK."
        rm -f $PIDFILE
    else
        echo "$0 not running"
        exit 1
    fi
}

case "$1" in
    start) start_command ;;
    stop) stop_command ;;
    restart)
        stop_command
        start_command
        ;;
    status)
        PID=`cat $PIDFILE`
        if [ -z `ps -p $PID` ]; then
            echo "Running"
        else
            echo "Process dead but pidfile exists."
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 2
        ;;
esac
